from telegram import Update, KeyboardButton, ReplyKeyboardMarkup, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from database.database import conn, cursor
from handlers.start import start
from telegram.error import BadRequest
from keyboards import getInlineKeyboardBut, getKeyboardBut
import json
from pathlib import Path
from handlers.text import actions, back_button

config_path = Path(__file__).parent.parent / 'config.json'

with open(config_path, 'r', encoding='utf-8') as f:
    config = json.load(f)

ADMIN_IDS = config["ADMIN_IDS"]
OWNER = config["OWNER"]

waiting_questions = {}
actions = {}

async def buttonKeyboardHandler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    uid = update.message.from_user.id
    username = update.message.from_user.username or ""

    if text == "üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞":
        cursor.execute("SELECT stars, withdrawn, referral_link FROM users WHERE id=?", (uid,))
        stars, withdrawn, link = cursor.fetchone()
        cursor.execute("SELECT COUNT(*) FROM users WHERE invited_by=?", (uid,))
        invited = cursor.fetchone()[0]
        achievements = []
        if invited >= 5:
            achievements.append("üîì <b>–†–µ–∫—Ä—É—Ç—ë—Ä</b> ‚Äî –ø—Ä–∏–≥–ª–∞—Å–∏–ª 5+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
        if stars + withdrawn >= 200:
            achievements.append("üíé <b>–ú–∞—Å—Ç–µ—Ä</b> ‚Äî –∑–∞—Ä–∞–±–æ—Ç–∞–ª 200+ –∑–≤—ë–∑–¥")
        cursor.execute("SELECT captcha_verified FROM users WHERE id=?", (uid,))
        if cursor.fetchone()[0]:
            achievements.append("üß† <b>–ì–µ–Ω–∏–π</b> ‚Äî –ø—Ä–æ—à—ë–ª –∫–∞–ø—á—É")

        achievement_text = (
            "\n\nüèÖ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n" + "\n".join(achievements)
            if achievements
            else "\n\nüèÖ <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–≤—ë–∑–¥—ã!"
        )

        await update.message.reply_text(
            f"""
<b>üë§ –ü—Ä–æ—Ñ–∏–ª—å:</b> @{username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}
‚≠ê <b>–ë–∞–ª–∞–Ω—Å:</b> {stars} –∑–≤—ë–∑–¥
üí∏ <b>–í—ã–≤–µ–¥–µ–Ω–æ:</b> {withdrawn} –∑–≤—ë–∑–¥
üë• <b>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤:</b> {invited} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
üîó <b>–í–∞—à–∞ —Å—Å—ã–ª–∫–∞:</b> <code>{link}</code>
    {achievement_text}
    """,
            parse_mode="HTML",
            reply_markup=getInlineKeyboardBut(uid),
        )
        
    elif text == "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è":
        await update.message.reply_text(
    """
<b>‚ú®üöÄ –î–æ—Ä–æ–≥–∏–µ –¥—Ä—É–∑—å—è! üéÅ‚≠êÔ∏è</b>

–ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –¥–ª—è –≤—Å–µ—Ö –ª—é–±–∏—Ç–µ–ª–µ–π Stars –∏ –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ Telegram!

<b>üì¢ –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ–º –±–æ—Ç–∞, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å Stars –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π –ø–æ –≤–∞—à–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ.</b>

<b>üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>
–ü—Ä–∏–≥–ª–∞—à–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–∞ –ø–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ –∏ –ø–æ–ª—É—á–∞–π –ø–æ 2.5 ‚≠êÔ∏è –∫–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω–∏ –ø—Ä–æ–π–¥—É—Ç –∫–∞–ø—á—É.

<b>‚ö°Ô∏è –í—ã–≤–æ–¥ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π, –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏ 15 ‚≠êÔ∏è –Ω–∞ –±–∞–ª–∞–Ω—Å–µ!</b>

<b>üîπ –ö–∞–∫ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π?</b>
–ü–µ—Ä–µ–π–¥–∏ –≤ —Ä–∞–∑–¥–µ–ª ¬´‚≠êÔ∏è –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å –∑–≤—ë–∑–¥—ã¬ª, —Å–∫–æ–ø–∏—Ä—É–π —Å–≤–æ—é —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–π –µ—ë:
- ‚úÖ –°—Ä–µ–¥–∏ –¥—Ä—É–∑–µ–π;
- ‚úÖ –í —á–∞—Ç–∞—Ö;
- ‚úÖ –í TikTok –∏ –¥—Ä—É–≥–∏—Ö —Å–æ—Ü—Å–µ—Ç—è—Ö.

<b>üîπ –ù–µ –æ–±–º–∞–Ω –ª–∏ —ç—Ç–æ?</b>
–ù–∞–º –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –Ω–∏–∫–æ–≥–æ –æ–±–º–∞–Ω—ã–≤–∞—Ç—å, –∞ —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–∞—à–∏ —Å–ª–æ–≤–∞, –º—ã –ø—É–±–ª–∏–∫—É–µ–º –≤—ã–≤–æ–¥—ã –∑–≤—ë–∑–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Ç—É—Ç @gifts_withdraws.

<b>üéÅ –ë–æ–Ω—É—Å! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–π–¥—ë—Ç –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ, –ø–æ–ª—É—á–∏—Ç 0.7 ‚≠êÔ∏è –Ω–∞ –±–∞–ª–∞–Ω—Å!</b>

–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏! üöÄ‚≠êÔ∏è
    """,
        parse_mode='HTML'
    )

    elif text == "‚ùì –ü–æ–º–æ—â—å":
        await update.message.reply_text(
        """
<b>‚ùì –ü–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</b>

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–¥–µ–ª –ø–æ–º–æ—â–∏! –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥—ë—Ç–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Å–º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –Ω—É–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

<b>üîπ –ö–∞–∫ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –∑–≤—ë–∑–¥—ã?</b>
- –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –≤ –±–æ—Ç–∞ –ø–æ –≤–∞—à–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ.
- –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–π–¥—ë—Ç –∫–∞–ø—á—É, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ <b>{} ‚≠êÔ∏è</b>.

<b>üîπ –ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –∑–≤—ë–∑–¥—ã?</b>
- –í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏ <b>–º–∏–Ω–∏–º—É–º 50 ‚≠êÔ∏è</b>.
- –î–ª—è –≤—ã–≤–æ–¥–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª ¬´üí∏ –í—ã–≤–µ—Å—Ç–∏ –∑–≤—ë–∑–¥—ã¬ª –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º.

<b>üîπ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–≤—ë–∑–¥—ã?</b>
- –ó–≤—ë–∑–¥—ã –º–æ–∂–Ω–æ –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ –±–æ–Ω—É—Å—ã –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.

<b>üîπ –£ –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã</b>
–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å¬ª –Ω–∏–∂–µ, –∏ –º—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –≤–∞–º –ø–æ–º–æ—á—å.

<b>üì¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã</b>
- –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –≤—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å: @FRRaskTC
        """,
        parse_mode='HTML',
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å", callback_data="ask")]
        ])
    )
        
    elif text == "üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å":
        from handlers.admin import admin_panel
        await admin_panel(update, context)